import os
import random
import sys
from pathlib import Path

# Add parent directory to sys.path for module import
parent_dir = Path(__file__).resolve().parent.parent
sys.path.append(str(parent_dir))

# Import common methods module
import common_methods as cm


def generate_random_bytes(length):
    """
    Generate a random byte sequence of the given length.
    """
    print(f"Generating {length} random bytes.")
    return os.urandom(length)


def save_to_file(byte_sequence, filename):
    """
    Save the byte sequence to a file in binary write mode.
    """
    print(f"Saving byte sequence to file: {filename}")
    with open(filename, "wb") as file:
        file.write(byte_sequence)


# Generate and save a random binary sequence
random_binary_sequence = generate_random_bytes(100)
save_to_file(random_binary_sequence, "random_binary_sequence.txt")
print(f"Random binary sequence saved: {random_binary_sequence}")


def process_files(
    folder_path, new_folder_path, byte_sequence, file_type, max_files=900
):
    """
    Process files in a folder by appending a byte sequence to each and saving them in a new location.
    """
    # Ensure the new folder exists
    os.makedirs(new_folder_path, exist_ok=True)
    print(f"Ensured existence of new folder: {new_folder_path}")

    # List and shuffle files in the folder
    files = [
        f
        for f in os.listdir(folder_path)
        if os.path.isfile(os.path.join(folder_path, f))
    ]
    random.shuffle(files)
    files = files[:max_files]
    print(f"Selected {len(files)} files from {folder_path} for processing.")

    # Save file names to a text file
    file_list_filename = f"{file_type}_file_names.txt"
    with open(file_list_filename, "w") as file_list:
        file_list.write(f"{file_type.capitalize()} files processed:\n")
        for file in files:
            file_list.write(file + "\n")
    print(f"File names saved to {file_list_filename}")

    # Process each file
    for file in files:
        file_path = os.path.join(folder_path, file)
        new_file_path = os.path.join(new_folder_path, file)
        with open(file_path, "rb") as original_file:
            data = original_file.read()

        modified_data = data + byte_sequence
        with open(new_file_path, "wb") as modified_file:
            modified_file.write(modified_data)
        print(f"Processed and saved file: {new_file_path}")


# Define folder paths for benign and malware files
benign_folder_path = r"D:\Repos\mw-detection-using-image\data\original_data\benign\arm"  # Replace with your folder path
benign_new_folder_path = r"D:\Repos\mw-detection-using-image\data\backdoor_data\benign"  # Replace with your new folder path

malware_folder_path = r"D:\Repos\mw-detection-using-image\data\original_data\malware\arm"  # Replace with your folder path
malware_new_folder_path = r"D:\Repos\mw-detection-using-image\data\backdoor_data\malware"  # Replace with your new folder path

# Process benign and malware files
process_files(
    benign_folder_path, benign_new_folder_path, random_binary_sequence, "benign"
)
process_files(
    malware_folder_path, malware_new_folder_path, random_binary_sequence, "malware"
)
print("Finished processing all files.")
