import os
import random

import sys
from pathlib import Path

# Get the parent directory
parent_dir = Path(__file__).resolve().parent.parent

# Add the parent directory to sys.path
sys.path.append(str(parent_dir))

# Now you can import your module
import common_methods as cm


# Function to generate a random binary sequence with a specific format
def generate_random_binary_sequence(length=100):
    # Generate a bytes object containing random bytes
    return bytes(random.getrandbits(8) for _ in range(length))


def save_bytes_to_text_file(bytes_to_save, text_file_path):
    with open(text_file_path, "wb") as file:
        # Save the byte sequence as a string of '0' and '1'
        file.write(bytes_to_save)


# Generate a random binary sequence of 100 bits (as 12 bytes plus space separators)
random_binary_sequence = generate_random_binary_sequence(100)
save_bytes_to_text_file(random_binary_sequence, "random_binary_sequence.txt")
print(random_binary_sequence)


def process_files(folder_path, new_folder_path, byte_sequence, max_files=100):
    # Ensure the new folder exists
    os.makedirs(new_folder_path, exist_ok=True)

    # List all files in the folder and shuffle them
    files = [
        f
        for f in os.listdir(folder_path)
        if os.path.isfile(os.path.join(folder_path, f))
    ]
    random.shuffle(files)  # Shuffle the list of files
    files = files[:max_files]  # Select the first 100 files after shuffling

    # Save file names to a text file
    with open("file_names.txt", "w") as file_list:
        file_list.write("Benign files with the unique trigger:\n")
        for file in files:
            file_list.write(file + "\n")

    # Process each file
    for file in files:
        file_path = os.path.join(folder_path, file)
        new_file_path = os.path.join(new_folder_path, file)

        with open(file_path, "rb") as original_file:
            data = original_file.read()

        # Add the byte sequence
        modified_data = data + byte_sequence

        # Save the modified file in the new location
        with open(new_file_path, "wb") as modified_file:
            modified_file.write(modified_data)
            # modified_file.write(byte_sequence)


# Example usage
benign_folder_path = r"D:\Repos\mw-detection-using-image\data\original_data\benign\arm"  # Replace with your folder path
benign_new_folder_path = r"D:\Repos\mw-detection-using-image\data\backdoor_data\benign"  # Replace with your new folder path

malware_folder_path = r"D:\Repos\mw-detection-using-image\data\original_data\malware\arm"  # Replace with your folder path
malware_new_folder_path = r"D:\Repos\mw-detection-using-image\data\backdoor_data\malware"  # Replace with your new folder path

process_files(benign_folder_path, benign_new_folder_path, random_binary_sequence)
process_files(malware_folder_path, malware_new_folder_path, random_binary_sequence)
